{% extends "base" %}
{% block title %}Create Post - {{ super() }}{% endblock title %}
{% block body %}

<!-- Create Post Modal -->
<div id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
          <form id="create_post_form" method="post" action="/post/create" enctype="multipart/form-data">
            <div class="modal-header">
                <h5 class="modal-title" id="createPostModalLabel">Create a New Post</h5>
            </div>
            <div class="modal-body">
                    <div class="mb-3">
                        <label for="text" class="form-label">Text</label>
                        <textarea name="text" id="text" class="form-control" maxlength="250" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="file" class="form-label">Image (optional)</label>
                        <input name="file" type="file" id="file" class="form-control">
                        <div id="image-preview" style="display: none; position: relative;">
                            <img id="preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 200px;">
                            <button type="button" id="remove-image" class="btn btn-danger btn-sm" style="position: absolute; top: 5px; right: 5px;">âœ–</button>
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
              <input type="submit" value="Publish" class="btn btn-primary" />
            </div>
          </form>
        </div>
    </div>
</div>

<!-- Full Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center full-image-modal">
                <img src="" alt="Full image">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById("file");
    const imagePreview = document.getElementById("image-preview");
    const previewImg = document.getElementById("preview-img");
    const removeImageButton = document.getElementById("remove-image");

    fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    removeImageButton.addEventListener("click", () => {
        fileInput.value = ""; // Clear the file input
        imagePreview.style.display = "none";
    });

    document.getElementById("posts_list").addEventListener("click", function (event) {
        if (event.target.classList.contains("post-image")) {
            const fullImageSrc = event.target.getAttribute("data-src");
            document.querySelector("#imageModal img").src = fullImageSrc;
        }
    });

    async function submitPost() {
        const formData = new FormData();
        formData.append("text", document.getElementById("text").value);
        const fileInput = document.getElementById("file");
        if (fileInput.files.length > 0) {
            formData.append("file", fileInput.files[0]);
        }

        try {
            const response = await fetch("/post/create", {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorText = await response.text();
                alert("Failed to create post: " + errorText);
            }
        } catch (error) {
            alert("An error occurred: " + error.message);
        }
    }

    async function likePost(postId, action) {
        try {
            const response = await fetch("/post/like", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ post_id: postId, action }),
            });

            if (response.ok) {
                const likesElement = document.getElementById(`likes-${postId}`);
                const currentLikes = parseInt(likesElement.textContent, 10);

                if (action === "like") {
                    if (currentLikes === 1) {
                        likesElement.textContent = 0; // Remove like
                    } else {
                        likesElement.textContent = 1; // Set like
                    }
                } else if (action === "dislike") {
                    if (currentLikes === -1) {
                        likesElement.textContent = 0; // Remove dislike
                    } else {
                        likesElement.textContent = -1; // Set dislike
                    }
                }
            } else {
                const errorText = await response.text();
                alert("Failed to update like/dislike: " + errorText);
            }
        } catch (error) {
            alert("An error occurred: " + error.message);
        }
    }
</script>


{% endblock %}

